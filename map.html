<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MAP</title>
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.css' rel='stylesheet' />
    <link href="map.css" rel="stylesheet" />
</head>
<body>
    <div id='map'></div>
    <div id='fixed-circle-overlay'></div>
    <script src='https://unpkg.com/@turf/turf@6/turf.min.js'></script>
    <script>
      mapboxgl.accessToken = 'pk.eyJ1IjoibWF0c2Rkc2QiLCJhIjoiY20ybnZlcWdwMDgyMTJqc2NhaXZ1OXY1eCJ9.0jMxkpNKzhawFcWBWg6Yjg';
      var map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/streets-v11',
        center: [2.213749, 46.227638],
        zoom: 5,
        attributionControl: false
      });

      let markers = [];
      let lastClickedCoordinates = null;
      let currentRegionName = null;
      const circleRadius = 75;

      function calculateCircleRadiusInKm() {
        if (!lastClickedCoordinates) return 0;

        const center = map.getCenter();
        const edge = map.unproject([map.getContainer().offsetWidth / 2 + circleRadius, map.getContainer().offsetHeight / 2]);
        return turf.distance(
          turf.point([center.lng, center.lat]),
          turf.point([edge.lng, edge.lat]),
          {units: 'kilometers'}
        );
      }

      function getCurrentRegion(centerPoint) {
        const source = map.getSource('france-regions');
        if (!source) return null;

        const data = source._data;
        if (!data || !data.features) return null;

        const point = turf.point(centerPoint);

        for (const feature of data.features) {
          if (turf.booleanPointInPolygon(point, feature)) {
            return feature.properties.nom;
          }
        }
        return null;
      }

      function updateDepartmentsVisibility(regionName) {
        console.log(regionName);
        if (map.getLayer('department-borders')) {
          map.setFilter('department-borders', ['==', 'region', regionName || '']);
        }
      }

      function updateCircleVisibility() {
        const overlay = document.getElementById('fixed-circle-overlay');
        if (lastClickedCoordinates) {
          const radiusInKm = calculateCircleRadiusInKm();
          console.log(`Updated circle radius: ${radiusInKm.toFixed(2)} km`);
          
          const center = map.getCenter();
          const centerPoint = [center.lng, center.lat];
          
          if (radiusInKm <= 60) {
            overlay.style.display = 'block';
            markers.forEach(marker => marker.getElement().style.display = 'none');
            
            const newRegion = getCurrentRegion(centerPoint);
            console.log(newRegion)
            // Only update if the region has changed
            if (newRegion !== currentRegionName) {
              // Update the filter for the highlight layer
              if (map.getLayer('region-highlighted')) {
                map.setFilter('region-highlighted', ['==', 'nom', newRegion || '']);
              }
              // Update departments visibility
              updateDepartmentsVisibility(newRegion);
              currentRegionName = newRegion;
            }
          } else {
            overlay.style.display = 'none';
            markers.forEach(marker => marker.getElement().style.display = '');
            // Clear region highlighting when radius > 60km
            if (map.getLayer('region-highlighted')) {
              map.setFilter('region-highlighted', ['==', 'nom', '']);
            }
            // Clear departments visibility
            updateDepartmentsVisibility('');
            currentRegionName = null;
          }
        }
      }

      map.on('load', function() {
        // Load both region and department data in parallel
        Promise.all([
          fetch('https://raw.githubusercontent.com/gregoiredavid/france-geojson/master/regions-version-simplifiee.geojson').then(resp => resp.json()),
          fetch('https://raw.githubusercontent.com/gregoiredavid/france-geojson/master/departements-version-simplifiee.geojson').then(resp => resp.json()),
          fetch('https://main-vision.github.io/foot_by_region.json').then(resp => resp.json())
        ]).then(([regionData, departmentData, countData]) => {
          // Process regions data
          regionData.features.forEach(feature => {
            const region = feature.properties.nom;
            const countObj = countData.find(item => item.region === region);
            if (countObj) {
              feature.properties.count = countObj.count;
            }
          });

          // Process departments data - add region property
          departmentData.features.forEach(dept => {
            const deptCode = dept.properties.code;
            const regionFeature = regionData.features.find(region => 
              region.properties.code === deptCode.substring(0, 2) ||
              (deptCode.startsWith('97') && region.properties.code === '94') // Handle overseas departments
            );
            if (regionFeature) {
              dept.properties.region = regionFeature.properties.nom;
            }
          });

          // Add sources
          map.addSource('france-regions', {
            type: 'geojson',
            data: regionData
          });

          map.addSource('france-departments', {
            type: 'geojson',
            data: departmentData
          });

          // Add base region borders
          map.addLayer({
            'id': 'france-region-borders',
            'type': 'line',
            'source': 'france-regions',
            'layout': {},
            'paint': {
              'line-color': '#E94E1B',
              'line-width': 1
            }
          });

          // Add highlight layer for active region
          map.addLayer({
            'id': 'region-highlighted',
            'type': 'fill',
            'source': 'france-regions',
            'layout': {},
            'paint': {
              'fill-color': '#E94E1B',
              'fill-opacity': 0.2
            },
            'filter': ['==', 'nom', '']
          });

          // Add department borders layer
          map.addLayer({
            'id': 'department-borders',
            'type': 'line',
            'source': 'france-departments',
            'layout': {},
            'paint': {
              'line-color': '#000000',
              'line-width': 10
            },
            'filter': ['==', 'region', '']
          });

          // Add markers
          regionData.features.forEach((feature, index) => {
            if (feature.properties.count) {
              const center = turf.center(feature);
              
              const el = document.createElement('div');
              el.className = 'marker';
              el.innerText = feature.properties.count;

              const marker = new mapboxgl.Marker(el)
                .setLngLat(center.geometry.coordinates)
                .addTo(map);

              markers.push(marker);

              el.addEventListener('click', () => {
                lastClickedCoordinates = center.geometry.coordinates;
                const bbox = turf.bbox(feature);
                map.fitBounds(bbox, {
                  padding: 50,
                  maxZoom: 10
                });
                map.once('moveend', updateCircleVisibility);
              });
            }
          });
        });
      });

      map.on('move', updateCircleVisibility);
    </script>
</body>
</html>